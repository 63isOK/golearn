# 为什么使用etcd

官方定义：一个高可用的分布式kv存储，用于共享配置和服务发现。

etcd中常被分布式系统用得比较多的特征是：
- 一致性的kv存储
- 配置管理
- 服务发现
- 分布式协同功能

使用etcd比较多的场景是：
- 服务发现
- 分布式锁
- 分布式数据队列
- 分布式通知和协调
- 主备选举

etcd server大体分4大模块：
- 网络层(接入层) http(s) server
- raft模块
- 复制状态机
- 存储模块

客户端发送一个请求过来，顺序是：
- 客户端发送请求
- 接入层转发给存储模块
- 存储模块执行具体的事务处理，期间如果设计到节点状态更新，就交给raft
- raft模块进行仲裁和日志记录，之后同步给别的etcd节点，半数以上的节点确认节点状态的修改后，进行数据的持久化

# 数据通道
所有的节点两两之间都有长连接，是一个网状结构，进行如下通信：
- 领袖给群众发心跳包，群众回复消息
- 领袖给群众发送日志追加消息
- 领袖给群众发送快照数据
- 候选节点发起选举，向其他节点发起投票请求
- 群众将收到的写操作转发给领袖

etcd传递消息经过pb打包，依据消息类型的不同，数据量从10kb到1g都有，
消息传递的方式有两种：stream类型通道和pipeline类型通道。
- stream类型通道
    - 点到点之间的双向传输带
    - 过程：pb打包，放到传输带，传给对方，对方将回复消息进行pb打包，放到反向传输带
    - 适用于处理数据量较少的消息：eg 心跳、日志追加
    - 只为一个http长连接，交替向长连接进行读写操作
    - 节点启动就会与其他节点创建一个stream类型通道的长连接
    - stream类型通道内部：
        - 使用golang的http包实现
        - 包含两个channel：
            - http收到数据，pb解码，通过channel发送给raft模块
            - 通过channel接收raft模块的消息，写入stream类型通道(也就是pb打包，让后丢给http)
- pipeline类型通道
    - 同时有n个传输带，一次同时可以发送n个消息
    - 适用于处理数据量大的消息，eg： snapshot快照
    - 不使用长连接，使用短连接，用完就关闭
    - 当且仅当stream类型通道不可用时，pipeline也可以用于传输小数据量的消息
    - 可以并行发送多个消息，利用go协程，向对端发送http post请求，收到回复就关闭

# 数据交互

- 接入层和raft模块的交互
    - 上面也说了，两者之间是通过channel进行传递数据的
    - raft模块中有个RaftNode，一个消息盒子，用于和接入层交互
- etcd和客户端的交互
    - etcd会监听一个服务端口
    - etcd网络层接到消息，会传给raft模块，raft完成操作就会回复，或者请求因超时而关闭
- etcd节点之间的交互
    - 通过peer端口来进行通信

# 应用场景举例

## 服务注册和发现

服务发现的解释：
- 同一分布式集群中的进程或服务如何才能找到对方并建立连接 - 官方话
- 集群中，提供我想要的服务在哪个ip，哪个端口，需要通过名字就可以进行查找和链接 - 白话

解决服务发现需要先解决以下3个问题：
- 强一致、高可用的服务存储目录。etcd天生强一致性和高可用
- 注册服务和监控服务的健康状况的机制。etcd的key ttl保证监控健康状态
- 查找和链接服务的机制。使用etcd的主题和代理

这点可用应用在两个场景：
- 微服务中的服务注册和服务发现
- paas平台中，多实例和故障发生时的动态配置问题

## 消息发布和订阅

这是分布式系统上，组件之间最常用的通信机制。利用这种通信机制可以实现配置的集中式管理和实时动态更新。

这点可用应用在两个场景：
- 配置信息更新
    - 应用在启动时取etcd获取一次配置，并在etcd上订阅(也就是在etcd上注册一个watcher并等待)
    - 配置有更新时，etcd会通知应用
- 分布式日志收集系统
- 系统中新需要动态自动获取与人工敢于修改信息的请求内容。

## 负载均衡

分布式系统中，将数据和服务部署多份，可以提高可用性，虽然对数据的写性能有一定影响，但可以实现访问时的负载均衡，流量也可以分流到不同机器上。

这点可用应用在两个场景：
- etcd本身分布式架构存储的信息就支持负载均衡
    - 将数据量`小`但访问`频繁`的数据放到etcd，是不错的选择。
- 利用etcd维护一个负载均衡节点表
    - 可通过轮询式将请求发给存活的节点

## 分布式通知和协调

和消息的发布订阅有点相似。

这点可用应用在两个场景：
- 通过etcd进行低耦合的liveness probe
    - 检测系统和被检测系统通过etcd的目录进行间接关联，降低耦合
- 通过etcd完成系统调度
    - 如推送系统，控制台定要要推送的消息，丢给etcd，etcd会推送给客户端
- 通过etcd完成工作汇报
    - 子任务可以在etcd注册一个临时工作目录，并定时汇报自己的进度，那么任务管理者就可以实时获取任务进度。

## 分布式锁

锁服务有两种使用方式：
- 保持独占
- 控制时序

etcd的强一致性，很容易实现分布式锁

这点可用应用在两个场景：
- 保持独占
    - etcd为此提供了一个cas api，保证同一时刻只有一个节点可以完成某个操作，成功就表示节点获得了分布式锁
- 控制时序
    - 试图获取锁的所有用户都会进入等待队列。etcd为此也提供了一套api

## 分布式队列

分布式队列的一般用法和分布式锁的控制时序类似：创建一个fifo队列来保证顺序。  
另一种用法就是达到某个条件时再统一按顺序执行。/queue目录中创建一个/queue/condition

第二种用法使用场景非常广，condition可以表示很多东西：
- 队列大小，小任务全部准备就绪就可以开始执行
- 某个任务不在队列中，保证任务块的执行顺序
- 仅仅是开始任务的通知，可有控制程序指定

## 集群监控和leader竞选

将需要长时间进行cpu计算或i/o操作的，让领袖来处理，再分发给群众

## 使用小结

- etcd v2 使用http接口
- etcd v3 使用grpc接口
    - 好处是提升连接效率
    - 坏处是便利性不如v2，不便于维护长连接的应用场景

多个分布式kv存储的对比：
- etcd的优势：配置信息共享和方便运维
- consul的优势：服务发现
- zookeeper的优势：稳定性

使用etcd的项目：
- coreos，容器linux
- kubernetes，k8s存储各类资源对象以及服务发现
- cloud foundry，paas平台的监控模块hm9000存储应用状态信息，并提供全局锁
- fleet、locksmith、vulcand、doorman等提供kv存储

etcd概念：
- raft： etcd采用的分布式系统强一致性算法
- node： 一个raft状态机实例
- member： 一个etcd实例，管理node，并为客户端提供服务
- cluster： 由多个member构成，遵循raft一致性协议的etcd集群
- peer： 对同一etcd集群中另外一个member的叫法
- clinet： 连接etcd服务请求服务的，eg：获取k-v，写数据、watch更新的程序都称为client
- proposal： 一个需要经过raft一致性协议的请求。eg：写请求，或配置更新请求
- quorum： 法定人数，也就是半数以上 (n+1)/2
- wal： 预写式日志，etcd用于持久化存储的日志格式
- snapshot： 快照，为了防止wal过多而设置的快照，用于存储etcd的数据状态
- proxy： etcd的一种模式，为集群提供反向代理服务
- leader： 领袖节点
- follower： 群众节点
- candidate： 群众没在一定时间内收到领袖的心跳，就会发起选举，并称为候选者
- term： 任期，节点从领袖到洗一次竞选的时间
- index： wal日志数据项编号，也称条目编号，raft中通过term和index来定位数据
- key： 用户定义的，用于存储和获取用户定义数据的标识符
- key space： 键空间，etcd集群内所有键的集合
- revision： 集群中64位的计数器。每次键空间的修改都会导致该计数器增加
- modification revision： 一个key最后一次修改的revision
- lease： 短期、可续订的租约，过期时会删除与之相关联的所有键
- transition： 事务，一个自动执行的操作集，要么一起成功，要么一起失败
- watcher： 观察者，客户端通过打开一个观察者来获取指定key范围的更新
- key range： 键范围，key的集合
- endpoint： 指向etcd服务或资源的url
- compaction： etcd压缩操作
- key version： 键版本，一个key从创建开始修改的次数，和revision的概念不一样
