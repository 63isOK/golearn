# 第一版设计

- 不考虑异常情况
    - kms重启/client重连
    - 不考虑持久化
- 整个服务用一个可执行,不考虑微服务
- 模块从上到下依次是:
    - ws服务(用于接收处理网页请求)
    - 资源管理(对上,管理ws连接对象;对下,管理kms资源和状态)
    - 业务api(将kms底层信令封装含有业务意义的api); 自增序号生成器(辅助实现kms信令)
    - kms api(基于kurento协议的api)
- 本次利用kurento能处理多条信令的特征,来减少网络请求次数

## 实现逻辑

ws服务,主要分两部分:
- 供客户端连接的ws服务
    - 创建一个ws服务
    - 为每个client创建两个协程,用于读/写消息
    - 每个client会有一个send通道
    - 每个client都会用到资源管理的 连接/断开/收到消息的通道,因为是共用的,就丢到资源管理
- 连接kms的ws客户端
    - 创建一个ws client
    - 创建两个协程,用于读写
    - 有一个send通道
    - 会用到资源管理的 连接/断开/收到消息通道,和上面的通道不一致,这个是针对kms的

资源管理,主要包含两个数据结构和一个逻辑处理中心:
- client资源管理
    - 一个数据结构,维护所有的客户端资源和kms连接资源
    - 通过管道完成和所有客户端和kms服务的消息交互,以及状态检测
- kms资源管理
    - 一个数据结构
    - 保存所有申请的kms资源和当前状态
- 一个映射关系
    - 保存了用户申请了哪些资源
- 一个映射关系
    - 保存了哪个kms申请了哪些资源
- 逻辑处理中心
    - 主协程,处理所有的业务
    - 用户加入/推拉流/退出

业务api:
- 保活
- 创建会议
- 销毁会议
- 申请传输资源(涵盖了WebRtcEndpoint/RtpEndpoint)
    - 申请媒体元素
    - 订阅事件
    - 连接指定对象
- 媒体类型协商(处理sdp)
- 传输通道协商(处理ice)

kms api:
- 基于kurento 协议改写

    
